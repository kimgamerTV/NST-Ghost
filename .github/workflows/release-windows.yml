name: Build NST Windows (MXE)
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential p7zip-full autoconf automake autopoint bash bison \
          bzip2 flex g++ g++-multilib gettext git gperf intltool libffi-dev \
          libgdk-pixbuf-2.0-dev libgmp-dev libltdl-dev libmpc-dev libmpfr-dev \
          libtool libtool-bin libssl-dev libxml-parser-perl lzip openssl patch \
          perl pkg-config python3 python3-pip python3-mako ruby scons sed \
          unzip wget xz-utils



    - name: Set cache key date
      id: cache-date
      run: echo "month=$(date +'%Y-%m')" >> $GITHUB_OUTPUT
      
    - name: Cache MXE build
      id: cache-mxe
      uses: actions/cache@v4
      with:
        path: ~/mxe
        key: mxe-qt6-static-v3-${{ runner.os }}-${{ steps.cache-date.outputs.month }}
        restore-keys: |
          mxe-qt6-static-v3-${{ runner.os }}-
    
    - name: Clone MXE
      if: steps.cache-mxe.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/mxe/mxe.git ~/mxe
    
    - name: Configure MXE settings
      if: steps.cache-mxe.outputs.cache-hit != 'true'
      run: |
        cd ~/mxe
        echo "MXE_TARGETS := x86_64-w64-mingw32.static" > settings.mk
        echo "MXE_PLUGIN_DIRS := plugins/gcc13" >> settings.mk
        cat settings.mk
    
    - name: Build MXE GCC toolchain
      if: steps.cache-mxe.outputs.cache-hit != 'true'
      run: |
        cd ~/mxe
        make JOBS=$(nproc) gcc
      timeout-minutes: 90
    
    - name: Build Qt6 for Windows
      if: steps.cache-mxe.outputs.cache-hit != 'true'
      run: |
        cd ~/mxe
        make JOBS=$(nproc) qt6-qtbase qt6-qttools
      timeout-minutes: 300
    
    - name: Verify MXE installation
      run: |
        echo "=== Checking MXE binaries ==="
        ls -la ~/mxe/usr/bin/ | grep x86_64-w64-mingw32 || true
        echo ""
        echo "=== Checking Qt6 installation ==="
        ls -la ~/mxe/usr/x86_64-w64-mingw32.static/qt6/ 2>/dev/null || echo "Qt6 directory not found"
        echo ""
        echo "=== Looking for cmake wrapper ==="
        find ~/mxe/usr/bin -name "*cmake*" -type f 2>/dev/null || true
        echo ""
        echo "=== Checking installed packages ==="
        ls ~/mxe/usr/x86_64-w64-mingw32.static/installed/ 2>/dev/null || true
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        export PATH="$HOME/mxe/usr/bin:$PATH"
        x86_64-w64-mingw32.static-cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/
    
    - name: Build
      run: |
        cd build
        export PATH="$HOME/mxe/usr/bin:$PATH"
        cmake --build . --config Release -j$(nproc)
    
    - name: Install to staging directory
      run: |
        cd build
        export PATH="$HOME/mxe/usr/bin:$PATH"
        DESTDIR=$PWD/install cmake --install .
    
    - name: Collect binaries
      run: |
        mkdir -p $GITHUB_WORKSPACE/package
        cd build/install
        echo "=== Searching for NST.exe ==="
        find . -name "NST.exe" -type f
        echo ""
        echo "=== Directory structure ==="
        ls -la
        echo ""
        if [ -f ./bin/NST.exe ]; then
          echo "Found NST.exe at ./bin/NST.exe"
          cp ./bin/NST.exe $GITHUB_WORKSPACE/package/
        elif [ -f ./usr/bin/NST.exe ]; then
          echo "Found NST.exe at ./usr/bin/NST.exe"
          cp ./usr/bin/NST.exe $GITHUB_WORKSPACE/package/
        elif [ -f ./usr/x86_64-w64-mingw32.static/bin/NST.exe ]; then
          echo "Found NST.exe at ./usr/x86_64-w64-mingw32.static/bin/NST.exe"
          cp ./usr/x86_64-w64-mingw32.static/bin/NST.exe $GITHUB_WORKSPACE/package/
        else
          echo "ERROR: NST.exe not found!"
          echo "Searching entire directory tree:"
          find . -type f -name "*.exe"
          exit 1
        fi
        echo ""
        echo "=== Copying DLL files ==="
        find . -name "*.dll" -type f -exec cp {} $GITHUB_WORKSPACE/package/ \; || true
        echo ""
        echo "=== Files copied to package ==="
        ls -lh $GITHUB_WORKSPACE/package/
    
    - name: Copy Qt dependencies manually
      run: |
        export PATH="$HOME/mxe/usr/bin:$PATH"
        cd $GITHUB_WORKSPACE/package
        QT_BIN="$HOME/mxe/usr/x86_64-w64-mingw32.static/qt6/bin"
        if [ -d "$QT_BIN" ]; then
          echo "Copying Qt6 DLLs from $QT_BIN"
          cp "$QT_BIN"/Qt6*.dll . 2>/dev/null || true
        fi
        QT_PLUGINS="$HOME/mxe/usr/x86_64-w64-mingw32.static/qt6/plugins"
        if [ -d "$QT_PLUGINS" ]; then
          echo "Copying Qt6 plugins"
          mkdir -p plugins
          cp -r "$QT_PLUGINS"/platforms plugins/ 2>/dev/null || true
          cp -r "$QT_PLUGINS"/styles plugins/ 2>/dev/null || true
        fi
        echo "[Paths]" > qt.conf
        echo "Plugins = plugins" >> qt.conf
        echo "Prefix = ." >> qt.conf
        echo ""
        echo "=== Final package contents ==="
        ls -lah
        echo ""
        echo "=== Plugins directory ==="
        ls -lah plugins/ 2>/dev/null || echo "No plugins directory"
    
    - name: List package contents
      run: |
        echo "=== Package contents ==="
        ls -lah package/
        echo ""
        echo "=== File types ==="
        file package/* 2>/dev/null || true
        echo ""
        echo "=== Total package size ==="
        du -sh package/
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: NST-Windows-MXE-x64
        path: package/
        if-no-files-found: error
