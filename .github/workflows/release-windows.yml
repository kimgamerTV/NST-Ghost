name: Build NST Windows
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Qt with aqtinstall
      run: |
        pip install aqtinstall
        aqt install-qt windows desktop 6.8.1 win64_mingw
        echo "${{ github.workspace }}/6.8.1/mingw_64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "${{ github.workspace }}/Tools/mingw1310_64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Install MinGW
      run: |
        aqt install-tool windows desktop tools_mingw90 qt.tools.win64_mingw900
    
    - name: Verify Qt installation
      run: |
        qmake --version
        where qmake
        gcc --version
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ github.workspace }}/6.8.1/mingw_64"
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release -j4
    
    - name: Install to staging directory
      run: |
        cd build
        $env:DESTDIR = "$PWD/install"
        cmake --install .
    
    - name: Deploy Qt dependencies
      run: |
        cd build/install
        # Find NST.exe
        $exePath = Get-ChildItem -Recurse -Filter "NST.exe" | Select-Object -First 1
        if ($exePath) {
          Write-Host "Found NST.exe at: $($exePath.FullName)"
          $exeDir = $exePath.DirectoryName
          
          # Run windeployqt
          windeployqt --release --no-translations "$($exePath.FullName)"
          
          # Create package directory
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/package"
          
          # Copy everything from exe directory
          Copy-Item -Path "$exeDir/*" -Destination "${{ github.workspace }}/package/" -Recurse -Force
          
          Write-Host "Package contents:"
          Get-ChildItem "${{ github.workspace }}/package/" -Recurse | Select-Object FullName
        } else {
          Write-Error "NST.exe not found!"
          exit 1
        }
    
    - name: List package contents
      run: |
        Write-Host "=== Package contents ==="
        Get-ChildItem "${{ github.workspace }}/package/" -Recurse | Format-Table Name, Length
        
        Write-Host "`n=== Total package size ==="
        $size = (Get-ChildItem "${{ github.workspace }}/package/" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host ("{0:N2} MB" -f $size)
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: NST-Windows-x64
        path: package/
        if-no-files-found: error
