name: Build NST Windows
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Qt with aqtinstall
      run: |
        pip install aqtinstall
        # Install Qt 6.8.1
        aqt install-qt windows desktop 6.8.1 win64_mingw
        # Install MinGW separately
        aqt install-tool windows desktop tools_mingw90 qt.tools.win64_mingw900
        
        # Debug: Show what was installed
        Write-Host "=== Directory structure after aqt installation ==="
        Get-ChildItem -Path . -Directory | Select-Object Name
        if (Test-Path "Tools") {
          Get-ChildItem -Path "Tools" -Recurse -Depth 2 | Select-Object FullName
        }
      shell: pwsh
    
    - name: Install Ninja
      run: choco install ninja
      shell: pwsh
    
    - name: Set environment variables
      run: |
        # Determine actual MinGW path
        $mingwPath = ""
        $possiblePaths = @(
          "${{ github.workspace }}/Tools/mingw900_64",
          "${{ github.workspace }}/Tools/mingw90",
          "${{ github.workspace }}/6.8.1/mingw_64"
        )
        
        foreach ($path in $possiblePaths) {
          $gccPath = Join-Path $path "bin\gcc.exe"
          if (Test-Path $gccPath) {
            $mingwPath = $path
            Write-Host "Found MinGW at: $mingwPath"
            break
          }
        }
        
        if (-not $mingwPath) {
          Write-Error "MinGW not found in any expected location"
          Write-Host "Searching entire workspace..."
          Get-ChildItem -Path "${{ github.workspace }}" -Recurse -Filter "gcc.exe" | Select-Object FullName
          exit 1
        }
        
        echo "MINGW_PATH=$mingwPath" >> $env:GITHUB_ENV
        echo "Qt6_DIR=${{ github.workspace }}/6.8.1/mingw_64" >> $env:GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=${{ github.workspace }}/6.8.1/mingw_64" >> $env:GITHUB_ENV
        echo "${{ github.workspace }}/6.8.1/mingw_64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "$mingwPath/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh
    
    - name: Verify installation
      run: |
        Write-Host "=== Qt Version ==="
        qmake --version
        
        Write-Host "`n=== MinGW Compiler ==="
        $gccPath = Join-Path $env:MINGW_PATH "bin\gcc.exe"
        if (Test-Path $gccPath) {
          & $gccPath --version
          Write-Host "Location: $gccPath"
        } else {
          Write-Error "GCC not found at $gccPath"
          exit 1
        }
        
        Write-Host "`n=== Ninja ==="
        ninja --version
        
        Write-Host "`n=== CMake ==="
        cmake --version
      shell: pwsh
    
    - name: Configure CMake
      run: |
        # Use the MinGW path we discovered
        $mingwBin = Join-Path $env:MINGW_PATH "bin"
        $gccPath = Join-Path $mingwBin "gcc.exe"
        $gxxPath = Join-Path $mingwBin "g++.exe"
        
        Write-Host "Using compiler: $gxxPath"
        if (-not (Test-Path $gxxPath)) {
          Write-Error "Compiler not found at $gxxPath"
          exit 1
        }
        
        cmake -S . -B build `
          -G Ninja `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}\6.8.1\mingw_64" `
          -DCMAKE_C_COMPILER="$gccPath" `
          -DCMAKE_CXX_COMPILER="$gxxPath"
      shell: pwsh
    
    - name: Build
      run: cmake --build build --config Release --parallel 4
      shell: pwsh
    
    - name: Install to staging directory
      run: |
        cmake --install build --prefix build/install
      shell: pwsh
    
    - name: Deploy Qt dependencies
      run: |
        $installDir = "build/install"
        
        # Find NST.exe
        $exePath = Get-ChildItem -Path $installDir -Recurse -Filter "NST.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if ($exePath) {
          Write-Host "Found NST.exe at: $($exePath.FullName)"
          $exeDir = $exePath.DirectoryName
          
          # Run windeployqt
          $windeployqt = "${{ github.workspace }}/6.8.1/mingw_64/bin/windeployqt.exe"
          & $windeployqt --release --no-translations --compiler-runtime "$($exePath.FullName)"
          
          # Create package directory
          New-Item -ItemType Directory -Force -Path "package" | Out-Null
          
          # Copy everything
          Copy-Item -Path "$exeDir/*" -Destination "package/" -Recurse -Force
          
          Write-Host "`nPackage contents:"
          Get-ChildItem "package/" | Format-Table Name, Length
        } else {
          Write-Error "NST.exe not found in $installDir"
          Write-Host "Directory contents:"
          Get-ChildItem $installDir -Recurse | Select-Object FullName
          exit 1
        }
      shell: pwsh
    
    - name: List package contents
      run: |
        Write-Host "=== Package contents ==="
        Get-ChildItem "package/" -Recurse | Format-Table Name, Length
        
        Write-Host "`n=== Total package size ==="
        $size = (Get-ChildItem "package/" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host ("{0:N2} MB" -f $size)
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: NST-Windows-x64
        path: package/
        if-no-files-found: error
