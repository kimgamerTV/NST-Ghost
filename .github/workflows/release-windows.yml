name: Build Windows Release

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: 'Version number (e.g., 0.4.3)'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install pybind11
        run: |
          pip install pybind11
          $pybind = python -m pybind11 --cmakedir
          echo "pybind11_DIR=$pybind" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      - name: Install Qt with aqtinstall
        run: |
          pip install aqtinstall
          aqt install-qt windows desktop 6.10.0 win64_msvc2022_64
        shell: pwsh
      
      - name: Install Ninja
        run: choco install ninja
        shell: pwsh
      
      - name: Install Lua
        run: vcpkg install lua:x64-windows
        shell: pwsh

      
      - name: Set environment variables
        run: |
          echo "Qt6_DIR=${{ github.workspace }}/6.10.0/msvc2022_64" >> $env:GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=${{ github.workspace }}/6.10.0/msvc2022_64" >> $env:GITHUB_ENV
          echo "${{ github.workspace }}/6.10.0/msvc2022_64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: pwsh
      
      - name: Configure CMake
        run: |
          cmake -S . -B build `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}\6.10.0\msvc2022_64;${{ env.pybind11_DIR }}" `
            -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
        shell: pwsh
      
      - name: Build
        run: cmake --build build --config Release --parallel 4
        shell: pwsh
      
      - name: Test
        run: |
          cd build
          ctest -C Release --output-on-failure
        shell: pwsh
      
      - name: Install to staging directory
        run: |
          $installPrefix = "${{ github.workspace }}\build\install"
          cmake --install build --prefix "$installPrefix"
        shell: pwsh
      
      - name: Deploy Qt dependencies
        run: |
          $installDir = "${{ github.workspace }}\build\install"
          $exePath = Get-ChildItem -Path $installDir -Recurse -Filter "NST.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($exePath) {
            Write-Host "Found NST.exe at: $($exePath.FullName)"
            $exeDir = $exePath.DirectoryName
            
            $windeployqt = "${{ github.workspace }}/6.10.0/msvc2022_64/bin/windeployqt.exe"
            Write-Host "Running windeployqt..."
            & $windeployqt --release --no-translations --compiler-runtime "$($exePath.FullName)"
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "windeployqt failed"
              exit 1
            }
            
            New-Item -ItemType Directory -Force -Path "package" | Out-Null
            Copy-Item -Path "$exeDir\*" -Destination "package\" -Recurse -Force
            
            # Copy vcpkg runtime DLLs (Lua, etc.)
            Write-Host "Copying vcpkg runtime DLLs..."
            $vcpkgBin = "C:/vcpkg/installed/x64-windows/bin"
            if (Test-Path $vcpkgBin) {
              Get-ChildItem "$vcpkgBin/*.dll" | ForEach-Object {
                Write-Host "  Copying $($_.Name)"
                Copy-Item $_.FullName -Destination "package\" -Force
              }
            } else {
              Write-Warning "vcpkg bin directory not found: $vcpkgBin"
            }
            
            Write-Host "`nPackage contents:"
            Get-ChildItem "package\" -Recurse | Select-Object FullName, Length | Format-Table
          } else {
            Write-Error "NST.exe not found"
            exit 1
          }
        shell: pwsh
      
      - name: Bundle Python Embeddable Package
        if: ${{ !cancelled() }}
        run: |
          $pythonVersion = "3.11.9"
          $pythonVersionShort = "311"
          $embedUrl = "https://www.python.org/ftp/python/${pythonVersion}/python-${pythonVersion}-embed-amd64.zip"
          
          Write-Host "Downloading Python ${pythonVersion} Embeddable Package..."
          Invoke-WebRequest -Uri $embedUrl -OutFile python-embed.zip
          
          # Extract to package/python
          New-Item -ItemType Directory -Force -Path "package/python" | Out-Null
          Expand-Archive python-embed.zip -DestinationPath "package/python" -Force
          
          # Modify ._pth file to enable site-packages and import site
          # This is CRITICAL for pip packages to work
          $pthFile = "package/python/python${pythonVersionShort}._pth"
          if (Test-Path $pthFile) {
            Write-Host "Modifying ${pthFile} to enable site-packages..."
            # Use array join instead of here-string to avoid YAML indentation issues
            $content = @(
              "python${pythonVersionShort}.zip",
              ".",
              "Lib/site-packages",
              "import site"
            ) -join "`n"
            Set-Content -Path $pthFile -Value $content -NoNewline
            Add-Content -Path $pthFile -Value ""
            Write-Host "._pth file updated:"
            Get-Content $pthFile
          }
          
          # Create site-packages directory
          New-Item -ItemType Directory -Force -Path "package/python/Lib/site-packages" | Out-Null
          
          # Copy Python scripts
          Write-Host "Copying Python scripts..."
          Copy-Item -Path "scripts" -Destination "package/" -Recurse -Force
          
          Write-Host "Python bundling complete!"
          Get-ChildItem "package/python" | Select-Object Name, Length | Format-Table
        shell: pwsh
      
      - name: Install pip dependencies for bundled Python
        if: ${{ !cancelled() }}
        run: |
          $sitePackages = "package/python/Lib/site-packages"
          
          # Install get-pip first (embeddable package doesn't include pip)
          Write-Host "Installing pip..."
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          & "package/python/python.exe" get-pip.py --target="$sitePackages" --no-warn-script-location
          
          # Install dependencies using the SAME Python version (critical for binary compatibility)
          Write-Host "Installing dependencies..."
          & "package/python/python.exe" -m pip install --target="$sitePackages" --no-warn-script-location `
            numpy `
            opencv-python-headless `
            Pillow
          
          # Note: Heavy AI dependencies (torch, easyocr) are installed by user via Feature Manager
          # This keeps the base package small (~50MB vs ~2GB)
          
          Write-Host "`nInstalled packages:"
          Get-ChildItem "$sitePackages" -Directory | Select-Object Name | Format-Table
        shell: pwsh
      
      - name: Create ZIP package
        run: |
          $version = "${{ inputs.version }}"
          $zipName = "NST-${version}-Windows-x64-MSVC.zip"
          
          Compress-Archive -Path "package\*" -DestinationPath $zipName -Force
          
          Write-Host "Created package: $zipName"
          $size = (Get-Item $zipName).Length / 1MB
          Write-Host ("Size: {0:N2} MB" -f $size)
        shell: pwsh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-Windows-x64-MSVC
          path: NST-${{ inputs.version }}-Windows-x64-MSVC.zip
          if-no-files-found: error
