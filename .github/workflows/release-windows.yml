name: Build NST Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      # 1. แก้ไขเวอร์ชัน Qt เป็นเวอร์ชันที่มีจริง
      QT_VERSION: 6.7.1
      QT_ARCH: win64_msvc2022_64
      BUILD_TYPE: Release

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # Install aqt (Qt installer)
      - name: Install aqtinstall
        run: python -m pip install --upgrade pip && pip install aqtinstall

      # Install Qt
      - name: Install Qt
        run: python -m aqt install-qt windows desktop $Env:QT_VERSION $Env:QT_ARCH --outputdir Qt

      # 2. เพิ่ม Qt bin folder เข้าไปใน PATH เพื่อให้ใช้ windeployqt ได้
      - name: Add Qt to PATH
        run: |
          echo "$PWD/Qt/$Env:QT_VERSION/$Env:QT_ARCH/bin" >> $GITHUB_ENV

      # Configure CMake
      - name: Configure CMake
        # ระบุ Generator ให้ชัดเจนเพื่อความมั่นใจ
        run: cmake -B build -S . -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=$Env:BUILD_TYPE

      # Build project
      - name: Build Project
        run: cmake --build build --config $Env:BUILD_TYPE

      # 3. ใช้ windeployqt เพื่อคัดลอกไฟล์ DLL ที่จำเป็น
      - name: Deploy Qt Application
        run: |
          # ชื่อ executable ต้องตรงกับที่ตั้งไว้ใน CMakeLists.txt (NST-Ghost.exe)
          windeployqt.exe --release --no-translations build/Release/NST-Ghost.exe

      # 4. อัปโหลดโฟลเดอร์ที่ Build เสร็จแล้วเป็น Artifact
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NST-Ghost-Windows-Portable
          # อัปโหลดทุกอย่างในโฟลเดอร์ build/Release
          path: build/Release/
