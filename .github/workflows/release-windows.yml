name: Build NST-Ghost on Windows

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      QT_VERSION: 6.9.2
      QT_ARCH: win64_msvc2022_64
      BUILD_TYPE: Release
      Python_ROOT_DIR: C:\hostedtoolcache\windows\Python\3.12.10\x64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.12

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Install aqtinstall
      run: python -m pip install aqtinstall==3.3.*

    - name: Install Qt
      run: python -m aqt install-qt windows desktop $Env:QT_VERSION $Env:QT_ARCH --outputdir Qt --autodesktop

    - name: Set Qt environment variables
      run: |
        echo "QT_ROOT_DIR=$PWD/Qt/$Env:QT_VERSION/$Env:QT_ARCH" >> $GITHUB_ENV
        echo "QT_PLUGIN_PATH=$PWD/Qt/$Env:QT_VERSION/$Env:QT_ARCH/plugins" >> $GITHUB_ENV
        echo "QML2_IMPORT_PATH=$PWD/Qt/$Env:QT_VERSION/$Env:QT_ARCH/qml" >> $GITHUB_ENV

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=$Env:BUILD_TYPE -DCMAKE_PREFIX_PATH=$Env:QT_ROOT_DIR

    - name: Build with CMake
      run: cmake --build build --config $Env:BUILD_TYPE

    - name: Run tests
      run: ctest --test-dir build --output-on-failure
