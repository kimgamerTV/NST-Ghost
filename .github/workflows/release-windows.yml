name: Build Windows Release

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: 'Version number (e.g., 0.4.3)'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      - name: Install Qt with aqtinstall
        run: |
          pip install aqtinstall
          aqt install-qt windows desktop 6.10.0 win64_msvc2022_64
        shell: pwsh
      
      - name: Install Ninja
        run: choco install ninja
        shell: pwsh
      
      - name: Install Lua
        run: choco install lua
        shell: pwsh

      
      - name: Set environment variables
        run: |
          echo "Qt6_DIR=${{ github.workspace }}/6.10.0/msvc2022_64" >> $env:GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=${{ github.workspace }}/6.10.0/msvc2022_64" >> $env:GITHUB_ENV
          echo "${{ github.workspace }}/6.10.0/msvc2022_64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: pwsh
      
      - name: Configure CMake
        run: |
          cmake -S . -B build `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}\6.10.0\msvc2022_64"
        shell: pwsh
      
      - name: Build
        run: cmake --build build --config Release --parallel 4
        shell: pwsh
      
      - name: Install to staging directory
        run: |
          $installPrefix = "${{ github.workspace }}\build\install"
          cmake --install build --prefix "$installPrefix"
        shell: pwsh
      
      - name: Deploy Qt dependencies
        run: |
          $installDir = "${{ github.workspace }}\build\install"
          $exePath = Get-ChildItem -Path $installDir -Recurse -Filter "NST.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($exePath) {
            Write-Host "Found NST.exe at: $($exePath.FullName)"
            $exeDir = $exePath.DirectoryName
            
            $windeployqt = "${{ github.workspace }}/6.10.0/msvc2022_64/bin/windeployqt.exe"
            Write-Host "Running windeployqt..."
            & $windeployqt --release --no-translations --compiler-runtime "$($exePath.FullName)"
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "windeployqt failed"
              exit 1
            }
            
            New-Item -ItemType Directory -Force -Path "package" | Out-Null
            Copy-Item -Path "$exeDir\*" -Destination "package\" -Recurse -Force
            
            Write-Host "`nPackage contents:"
            Get-ChildItem "package\" -Recurse | Select-Object FullName, Length | Format-Table
          } else {
            Write-Error "NST.exe not found"
            exit 1
          }
        shell: pwsh
      
      - name: Create ZIP package
        run: |
          $version = "${{ inputs.version }}"
          $zipName = "NST-${version}-Windows-x64-MSVC.zip"
          
          Compress-Archive -Path "package\*" -DestinationPath $zipName -Force
          
          Write-Host "Created package: $zipName"
          $size = (Get-Item $zipName).Length / 1MB
          Write-Host ("Size: {0:N2} MB" -f $size)
        shell: pwsh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-Windows-x64-MSVC
          path: NST-${{ inputs.version }}-Windows-x64-MSVC.zip
          if-no-files-found: error
