name: Build NST Windows
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Qt with aqtinstall
      run: |
        pip install aqtinstall
        # Install Qt 6.8.1
        aqt install-qt windows desktop 6.8.1 win64_mingw
        # Install MinGW separately (it's not in Qt's bin on Windows)
        aqt install-tool windows desktop tools_mingw90 qt.tools.win64_mingw900
      shell: pwsh
    
    - name: Install Ninja
      run: choco install ninja
      shell: pwsh
    
    - name: Set environment variables
      run: |
        echo "Qt6_DIR=${{ github.workspace }}/6.8.1/mingw_64" >> $env:GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=${{ github.workspace }}/6.8.1/mingw_64" >> $env:GITHUB_ENV
        echo "${{ github.workspace }}/6.8.1/mingw_64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "${{ github.workspace }}/Tools/mingw900_64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh
    
    - name: Verify installation
      run: |
        Write-Host "=== Qt Version ==="
        qmake --version
        Write-Host "`n=== Compiler ==="
        gcc --version
        g++ --version
        Write-Host "`n=== Ninja ==="
        ninja --version
        Write-Host "`n=== CMake ==="
        cmake --version
        Write-Host "`n=== Paths ==="
        Write-Host "PATH entries:"
        $env:PATH -split ';' | Where-Object { $_ -match 'mingw|Qt' }
      shell: pwsh
    
    - name: Configure CMake
      run: |
        # Don't set CC/CXX explicitly, let CMake find from PATH
        # MinGW 15.2.0 is already in PATH and compatible
        cmake -S . -B build `
          -G Ninja `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/6.8.1/mingw_64" `
          -DCMAKE_C_COMPILER=gcc `
          -DCMAKE_CXX_COMPILER=g++
      shell: pwsh
    
    - name: Build
      run: cmake --build build --config Release --parallel 4
      shell: pwsh
    
    - name: Install to staging directory
      run: |
        cmake --install build --prefix build/install
      shell: pwsh
    
    - name: Deploy Qt dependencies
      run: |
        $installDir = "build/install"
        
        # Find NST.exe
        $exePath = Get-ChildItem -Path $installDir -Recurse -Filter "NST.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if ($exePath) {
          Write-Host "Found NST.exe at: $($exePath.FullName)"
          $exeDir = $exePath.DirectoryName
          
          # Run windeployqt
          $windeployqt = "${{ github.workspace }}/6.8.1/mingw_64/bin/windeployqt.exe"
          & $windeployqt --release --no-translations --compiler-runtime "$($exePath.FullName)"
          
          # Create package directory
          New-Item -ItemType Directory -Force -Path "package" | Out-Null
          
          # Copy everything
          Copy-Item -Path "$exeDir/*" -Destination "package/" -Recurse -Force
          
          Write-Host "`nPackage contents:"
          Get-ChildItem "package/" | Format-Table Name, Length
        } else {
          Write-Error "NST.exe not found in $installDir"
          Write-Host "Directory contents:"
          Get-ChildItem $installDir -Recurse | Select-Object FullName
          exit 1
        }
      shell: pwsh
    
    - name: List package contents
      run: |
        Write-Host "=== Package contents ==="
        Get-ChildItem "package/" -Recurse | Format-Table Name, Length
        
        Write-Host "`n=== Total package size ==="
        $size = (Get-ChildItem "package/" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host ("{0:N2} MB" -f $size)
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: NST-Windows-x64
        path: package/
        if-no-files-found: error
