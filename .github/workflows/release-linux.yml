name: Build NST Linux
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libxcb-shape0 \
          libfuse2 \
          file \
          rpm \
          patchelf \
          desktop-file-utils \
          libfontconfig1-dev \
          libfreetype6-dev \
          libx11-dev \
          libx11-xcb-dev \
          libxext-dev \
          libxfixes-dev \
          libxi-dev \
          libxrender-dev \
          libxcb1-dev \
          libxcb-glx0-dev \
          libxcb-util0-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          librsvg2-bin
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.3'
        target: 'desktop'
        arch: 'linux_gcc_64'
        cache: true
        install-deps: true
    
    - name: Verify installation
      run: |
        echo "=== Qt Version ==="
        qmake --version
        
        echo -e "\n=== GCC Compiler ==="
        gcc --version
        
        echo -e "\n=== Ninja ==="
        ninja --version
        
        echo -e "\n=== CMake ==="
        cmake --version
    
    - name: Configure CMake
      run: |
        cmake -S . -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}" \
          -DCMAKE_INSTALL_PREFIX=/opt/nst \
          -DQT_DEPLOY_SUPPORT=OFF \
          -DSKIP_QT_DEPLOY=ON
        
        echo -e "\n=== CMake Configuration ==="
        echo "Build Type: Release"
        echo "Install Prefix: /opt/nst"
    
    - name: Build
      run: cmake --build build --config Release --parallel $(nproc)
    
    - name: Verify build output
      run: |
        echo "=== Build directory structure ==="
        find build -name "*.so" -o -name "NST" -type f
        echo ""
        echo "=== Checking library locations ==="
        ls -la build/BGA/ || true
        ls -la build/QtLingo/ || true
    
    - name: Install to staging directory
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
        mkdir -p AppDir/usr/lib/x86_64-linux-gnu
        
        cd build
        
        install -D -m 755 NST ../AppDir/usr/bin/NST
        install -D -m 755 BGA/libBGACore.so ../AppDir/usr/bin/libBGACore.so
        install -D -m 755 QtLingo/libQtLingo.so ../AppDir/usr/bin/libQtLingo.so
        
        cd ..
        
        install -D -m 644 packaging/debian/nst.desktop AppDir/usr/share/applications/nst.desktop
        install -D -m 644 packaging/icons/nst.svg AppDir/usr/share/icons/hicolor/scalable/apps/nst.svg
        
        echo "Installation completed, checking files..."
        ls -la AppDir/usr/bin/
        echo ""
        echo "Desktop file:"
        ls -la AppDir/usr/share/applications/
        echo ""
        echo "Icon:"
        ls -la AppDir/usr/share/icons/hicolor/scalable/apps/
    
    - name: Prepare AppDir structure
      run: |
        cd AppDir
        
        if [ ! -f "usr/bin/NST" ]; then
          echo "Error: NST binary not found at usr/bin/NST"
          echo "Contents of AppDir:"
          find . -type f
          exit 1
        fi
        
        echo "Found NST binary at: usr/bin/NST"
        
        if [ -f "usr/share/icons/hicolor/scalable/apps/nst.svg" ]; then
          echo "Converting SVG icon to PNG sizes..."
          mkdir -p usr/share/icons/hicolor/256x256/apps
          mkdir -p usr/share/icons/hicolor/128x128/apps
          
          rsvg-convert -w 256 -h 256 \
            usr/share/icons/hicolor/scalable/apps/nst.svg \
            -o usr/share/icons/hicolor/256x256/apps/nst.png
          
          rsvg-convert -w 128 -h 128 \
            usr/share/icons/hicolor/scalable/apps/nst.svg \
            -o usr/share/icons/hicolor/128x128/apps/nst.png
            
          echo "Icon conversion completed"
        fi
        
        if [ ! -f "usr/share/applications/nst.desktop" ]; then
          echo "Error: Desktop file not found"
          exit 1
        fi
        
        sed -i 's/Categories=.*/Categories=Development;/' usr/share/applications/nst.desktop
        
        echo "Desktop file fixed"
        
        cat > AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${HERE}/usr/bin:${LD_LIBRARY_PATH}"
        export QT_PLUGIN_PATH="${HERE}/usr/plugins"
        export QML_IMPORT_PATH="${HERE}/usr/qml"
        export QML2_IMPORT_PATH="${HERE}/usr/qml"
        exec "${HERE}/usr/bin/NST" "$@"
        EOF
        chmod +x AppRun
        
        ln -sf usr/share/applications/nst.desktop nst.desktop
        
        if [ -f usr/share/icons/hicolor/256x256/apps/nst.png ]; then
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png nst.png
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png .DirIcon
          echo "Created icon symlinks (256x256 PNG)"
        elif [ -f usr/share/icons/hicolor/scalable/apps/nst.svg ]; then
          ln -sf usr/share/icons/hicolor/scalable/apps/nst.svg nst.svg
          echo "Created icon symlinks (SVG fallback)"
        else
          echo "Warning: No icon found!"
        fi
        
        echo -e "\n=== AppDir structure created ==="
        ls -la
        echo -e "\n=== Icon files ==="
        find usr/share/icons -name "nst.*"
    
    - name: Deploy Qt dependencies
      run: |
        cd AppDir
        
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        
        wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy-plugin-qt-x86_64.AppImage
        
        echo "Deploying Qt dependencies..."
        ./linuxdeploy-x86_64.AppImage --appdir . --plugin qt || true
        
        echo -e "\n=== Deployment completed ==="
        echo "Libraries in usr/lib:"
        ls -lh usr/lib/ | head -20

    - name: Add Qt Wayland plugins
      run: |
        echo "Adding Qt Wayland platform plugins..."
        
        QT_PLUGIN_DIR=$(qtpaths6 --plugin-dir 2>/dev/null || echo "${{ env.Qt6_DIR }}/plugins")
        
        mkdir -p AppDir/usr/plugins/platforms
        
        for f in \
          libqwayland-egl.so \
          libqwayland-generic.so \
          libqwayland-xcomposite-egl.so \
          libqwayland-xcomposite-glx.so; do
          
          if [ -f "${QT_PLUGIN_DIR}/platforms/$f" ]; then
            echo "Copying $f"
            cp "${QT_PLUGIN_DIR}/platforms/$f" AppDir/usr/plugins/platforms/
          else
            echo "Warning: $f not found in ${QT_PLUGIN_DIR}/platforms/"
          fi
        done
        
        echo -e "\n=== Verifying Wayland plugins ==="
        ls -lh AppDir/usr/plugins/platforms/
