name: Build NST Linux
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libxcb-shape0 \
          libfuse2 \
          file \
          rpm \
          patchelf \
          desktop-file-utils \
          libfontconfig1-dev \
          libfreetype6-dev \
          libx11-dev \
          libx11-xcb-dev \
          libxext-dev \
          libxfixes-dev \
          libxi-dev \
          libxrender-dev \
          libxcb1-dev \
          libxcb-glx0-dev \
          libxcb-util0-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          librsvg2-bin
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Qt with aqtinstall
      run: |
        pip install aqtinstall
        # Install Qt 6.10.0 for Linux
        aqt install-qt linux desktop 6.10.0 gcc_64
    
    - name: Set environment variables
      run: |
        echo "Qt6_DIR=${{ github.workspace }}/6.10.0/gcc_64" >> $GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=${{ github.workspace }}/6.10.0/gcc_64" >> $GITHUB_ENV
        echo "${{ github.workspace }}/6.10.0/gcc_64/bin" >> $GITHUB_PATH
        echo "LD_LIBRARY_PATH=${{ github.workspace }}/6.10.0/gcc_64/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
    
    - name: Verify installation
      run: |
        echo "=== Qt Version ==="
        qmake --version
        
        echo -e "\n=== GCC Compiler ==="
        gcc --version
        
        echo -e "\n=== Ninja ==="
        ninja --version
        
        echo -e "\n=== CMake ==="
        cmake --version
    
    - name: Configure CMake
      run: |
        cmake -S . -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/6.10.0/gcc_64" \
          -DCMAKE_INSTALL_PREFIX=/usr
        
        echo -e "\n=== CMake Configuration ==="
        echo "Build Type: Release"
        echo "Install Prefix: /usr"
    
    - name: Build
      run: cmake --build build --config Release --parallel $(nproc)
    
    - name: Install to staging directory
      run: |
        DESTDIR="${{ github.workspace }}/AppDir" cmake --install build
    
    - name: Prepare AppDir structure
      run: |
        cd AppDir
        
        # Verify NST binary exists
        if [ ! -f "usr/bin/NST" ]; then
          echo "Error: NST binary not found at usr/bin/NST"
          echo "Contents of AppDir:"
          find . -type f
          exit 1
        fi
        
        echo "Found NST binary at: usr/bin/NST"
        
        # Convert SVG icon to PNG if needed
        if [ -f "usr/share/icons/hicolor/scalable/apps/nst.svg" ]; then
          echo "Converting SVG icon to PNG..."
          mkdir -p usr/share/icons/hicolor/256x256/apps
          rsvg-convert -w 256 -h 256 \
            usr/share/icons/hicolor/scalable/apps/nst.svg \
            -o usr/share/icons/hicolor/256x256/apps/nst.png
        fi
        
        # Verify desktop file exists
        if [ ! -f "usr/share/applications/nst.desktop" ]; then
          echo "Warning: Desktop file not found, creating one..."
          mkdir -p usr/share/applications
          cat > usr/share/applications/nst.desktop << 'DESKTOPEOF'
        [Desktop Entry]
        Type=Application
        Name=NST
        Comment=A tool for translating video games
        Exec=NST
        Icon=nst
        Categories=Utility;Development;
        Terminal=false
        DESKTOPEOF
        fi
        
        # Create AppRun script
        cat > AppRun << 'APPRUNEOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/bin:${LD_LIBRARY_PATH}"
        export QT_PLUGIN_PATH="${HERE}/usr/plugins"
        export QML_IMPORT_PATH="${HERE}/usr/qml"
        export QML2_IMPORT_PATH="${HERE}/usr/qml"
        exec "${HERE}/usr/bin/NST" "$@"
        APPRUNEOF
        chmod +x AppRun
        
        # Create symbolic links for AppImage
        ln -sf usr/share/applications/nst.desktop nst.desktop
        if [ -f usr/share/icons/hicolor/256x256/apps/nst.png ]; then
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png nst.png
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png .DirIcon
        fi
        
        echo -e "\n=== AppDir structure created ==="
        ls -la
    
    - name: Deploy Qt dependencies
      run: |
        cd AppDir
        
        # Download linuxdeploy
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        
        # Download linuxdeploy Qt plugin
        wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy-plugin-qt-x86_64.AppImage
        
        # Set Qt path for the plugin
        export QMAKE=${{ github.workspace }}/6.10.0/gcc_64/bin/qmake
        export LD_LIBRARY_PATH=${{ github.workspace }}/6.10.0/gcc_64/lib:$LD_LIBRARY_PATH
        
        # Deploy Qt dependencies
        echo "Deploying Qt dependencies..."
        ./linuxdeploy-x86_64.AppImage --appdir . --plugin qt || true
        
        echo -e "\n=== Deployment completed ==="
        echo "Libraries in usr/lib:"
        ls -lh usr/lib/ | head -20
    
    - name: Create AppImage
      run: |
        cd AppDir
        
        # Download appimagetool
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        
        # Extract appimagetool
        ./appimagetool-x86_64.AppImage --appimage-extract
        
        # Create AppImage
        ARCH=x86_64 ./squashfs-root/AppRun . ../NST-0.4.3-x86_64.AppImage
        
        cd ..
        chmod +x NST-0.4.3-x86_64.AppImage
        
        echo -e "\n=== AppImage created ==="
        ls -lh NST-0.4.3-x86_64.AppImage
        
        # Test AppImage
        ./NST-0.4.3-x86_64.AppImage --version || echo "Version check skipped"
    
    - name: Create tar.gz archive
      run: |
        mkdir -p package-tar/NST-0.4.3
        cd AppDir
        
        # Copy all files
        cp -r usr ../package-tar/NST-0.4.3/
        cp AppRun ../package-tar/NST-0.4.3/
        
        cd ../package-tar
        
        # Create README
        cat > NST-0.4.3/README.txt << 'READMEEOF'
        NST v0.4.3 - A tool for translating video games
        ================================================
        
        Installation:
        -------------
        Run: sudo ./install.sh
        
        This will copy files to:
        - /usr/bin/NST (executable)
        - /usr/share/applications/nst.desktop (desktop entry)
        - /usr/share/icons/ (application icon)
        - /usr/bin/ (required libraries)
        
        Uninstallation:
        ---------------
        Run: sudo ./uninstall.sh
        
        Manual Run (without installation):
        -----------------------------------
        ./AppRun
        
        Requirements:
        -------------
        - Linux x86_64
        - glibc 2.31+
        - libGL, libxcb, libxkbcommon
        
        READMEEOF
        
        # Create installation script
        cat > NST-0.4.3/install.sh << 'INSTALLEOF'
        #!/bin/bash
        set -e
        
        echo "Installing NST v0.4.3..."
        
        # Check if running as root
        if [ "$EUID" -ne 0 ]; then 
            echo "Please run as root (use sudo)"
            exit 1
        fi
        
        # Copy files
        echo "Copying files..."
        cp -r usr/* /usr/
        
        # Set permissions
        chmod +x /usr/bin/NST
        chmod +x /usr/bin/libBGACore.so* 2>/dev/null || true
        chmod +x /usr/bin/libQtLingo.so* 2>/dev/null || true
        
        # Update desktop database
        if command -v update-desktop-database >/dev/null 2>&1; then
            echo "Updating desktop database..."
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        # Update icon cache
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            echo "Updating icon cache..."
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        echo ""
        echo "Installation complete!"
        echo "You can now run 'NST' from terminal or find it in your applications menu."
        INSTALLEOF
        chmod +x NST-0.4.3/install.sh
        
        # Create uninstall script
        cat > NST-0.4.3/uninstall.sh << 'UNINSTALLEOF'
        #!/bin/bash
        set -e
        
        echo "Uninstalling NST..."
        
        # Check if running as root
        if [ "$EUID" -ne 0 ]; then 
            echo "Please run as root (use sudo)"
            exit 1
        fi
        
        # Remove files
        echo "Removing files..."
        rm -f /usr/bin/NST
        rm -f /usr/bin/libBGACore.so*
        rm -f /usr/bin/libQtLingo.so*
        rm -f /usr/share/applications/nst.desktop
        rm -f /usr/share/icons/hicolor/*/apps/nst.png
        rm -f /usr/share/icons/hicolor/scalable/apps/nst.svg
        
        # Update desktop database
        if command -v update-desktop-database >/dev/null 2>&1; then
            echo "Updating desktop database..."
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        # Update icon cache
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            echo "Updating icon cache..."
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        echo "Uninstallation complete!"
        UNINSTALLEOF
        chmod +x NST-0.4.3/uninstall.sh
        
        # Create archive
        tar -czf ../NST-0.4.3-Linux-x86_64.tar.gz NST-0.4.3/
        cd ..
        
        echo -e "\n=== tar.gz created ==="
        ls -lh NST-0.4.3-Linux-x86_64.tar.gz
    
    - name: Create DEB package
      run: |
        mkdir -p nst-deb/DEBIAN
        mkdir -p nst-deb/usr
        
        # Copy files from AppDir
        cp -r AppDir/usr/* nst-deb/usr/
        
        # Create control file
        cat > nst-deb/DEBIAN/control << 'CONTROLEOF'
        Package: nst
        Version: 0.4.3
        Section: utils
        Priority: optional
        Architecture: amd64
        Depends: libc6 (>= 2.31), libstdc++6 (>= 10), libgcc1, libgl1, libxcb1, libxkbcommon0, libxkbcommon-x11-0, libfontconfig1, libfreetype6, libdbus-1-3
        Maintainer: NST Ghost <you@example.com>
        Description: A tool for translating video games
         NST is a powerful tool for translating video games.
         It supports various game formats and provides an intuitive
         interface for translation workflows.
         .
         Built with Qt 6.10.0
        CONTROLEOF
        
        # Create postinst script
        cat > nst-deb/DEBIAN/postinst << 'POSTINSTEOF'
        #!/bin/bash
        set -e
        
        # Set permissions
        chmod +x /usr/bin/NST || true
        chmod +x /usr/bin/libBGACore.so* 2>/dev/null || true
        chmod +x /usr/bin/libQtLingo.so* 2>/dev/null || true
        
        # Update desktop database
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        # Update icon cache
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        exit 0
        POSTINSTEOF
        chmod +x nst-deb/DEBIAN/postinst
        
        # Create postrm script
        cat > nst-deb/DEBIAN/postrm << 'POSTRMEOF'
        #!/bin/bash
        set -e
        
        # Update desktop database
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        # Update icon cache
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        exit 0
        POSTRMEOF
        chmod +x nst-deb/DEBIAN/postrm
        
        # Build DEB package
        dpkg-deb --build nst-deb NST-0.4.3-Linux-x86_64.deb
        
        echo -e "\n=== DEB package created ==="
        ls -lh NST-0.4.3-Linux-x86_64.deb
        dpkg-deb --info NST-0.4.3-Linux-x86_64.deb
        echo -e "\n=== DEB contents ==="
        dpkg-deb --contents NST-0.4.3-Linux-x86_64.deb | head -20
    
    - name: Create RPM package
      run: |
        # Create RPM build directories
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
        
        # Create source tarball
        mkdir -p nst-rpm-source/nst-0.4.3/usr
        cp -r AppDir/usr/* nst-rpm-source/nst-0.4.3/usr/
        cd nst-rpm-source
        tar -czf ~/rpmbuild/SOURCES/nst-0.4.3.tar.gz nst-0.4.3/
        cd ..
        
        # Create RPM spec file
        cat > ~/rpmbuild/SPECS/nst.spec << 'SPECEOF'
        Name:           nst
        Version:        0.4.3
        Release:        1%{?dist}
        Summary:        A tool for translating video games
        
        License:        MIT
        URL:            https://github.com/yourusername/nst
        Source0:        %{name}-%{version}.tar.gz
        
        BuildArch:      x86_64
        
        Requires:       glibc >= 2.31, libstdc++ >= 10, libgcc, libGL, libxcb, libxkbcommon, fontconfig, freetype, dbus-libs
        
        %description
        NST is a powerful tool for translating video games.
        It supports various game formats and provides an intuitive
        interface for translation workflows.
        
        Built with Qt 6.10.0
        
        %prep
        %setup -q
        
        %install
        rm -rf $RPM_BUILD_ROOT
        mkdir -p $RPM_BUILD_ROOT
        cp -r usr $RPM_BUILD_ROOT/
        
        %post
        chmod +x /usr/bin/NST || true
        chmod +x /usr/bin/libBGACore.so* 2>/dev/null || true
        chmod +x /usr/bin/libQtLingo.so* 2>/dev/null || true
        
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        %postun
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        %files
        /usr/bin/NST
        /usr/bin/libBGACore.so*
        /usr/bin/libQtLingo.so*
        /usr/share/applications/nst.desktop
        /usr/share/icons/hicolor/*/apps/nst.*
        /usr/lib/*
        /usr/plugins/*
        /usr/qml/*
        
        %changelog
        * Sat Nov 08 2025 NST Ghost <you@example.com> - 0.4.3-1
        - Release version 0.4.3
        - Built with Qt 6.10.0
        SPECEOF
        
        # Build RPM
        rpmbuild -bb ~/rpmbuild/SPECS/nst.spec
        
        # Copy RPM to workspace
        find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} NST-0.4.3-Linux-x86_64.rpm \;
        
        echo -e "\n=== RPM package created ==="
        ls -lh NST-0.4.3-Linux-x86_64.rpm
        rpm -qpi NST-0.4.3-Linux-x86_64.rpm
    
    - name: Verify all packages
      run: |
        echo "=== All packages created ==="
        ls -lh NST-* | grep -E '\.(AppImage|tar\.gz|deb|rpm)$'
        
        echo -e "\n=== Package sizes ==="
        du -h NST-0.4.3-x86_64.AppImage \
               NST-0.4.3-Linux-x86_64.tar.gz \
               NST-0.4.3-Linux-x86_64.deb \
               NST-0.4.3-Linux-x86_64.rpm
        
        echo -e "\n=== Package details ==="
        echo "AppImage: Portable, run directly"
        echo "tar.gz: Manual installation with install.sh"
        echo "DEB: For Debian/Ubuntu (dpkg -i or apt install)"
        echo "RPM: For Fedora/RHEL/CentOS (rpm -i or dnf install)"
    
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: NST-0.4.3-x86_64-AppImage
        path: NST-0.4.3-x86_64.AppImage
        if-no-files-found: error
    
    - name: Upload tar.gz
      uses: actions/upload-artifact@v4
      with:
        name: NST-0.4.3-Linux-x86_64-tar
        path: NST-0.4.3-Linux-x86_64.tar.gz
        if-no-files-found: error
    
    - name: Upload DEB
      uses: actions/upload-artifact@v4
      with:
        name: NST-0.4.3-Linux-x86_64-deb
        path: NST-0.4.3-Linux-x86_64.deb
        if-no-files-found: error
    
    - name: Upload RPM
      uses: actions/upload-artifact@v4
      with:
        name: NST-0.4.3-Linux-x86_64-rpm
        path: NST-0.4.3-Linux-x86_64.rpm
        if-no-files-found: error
