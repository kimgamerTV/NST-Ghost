name: Build NST Linux
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libxcb-shape0 \
          libfuse2 \
          file \
          rpm \
          patchelf \
          desktop-file-utils \
          libfontconfig1-dev \
          libfreetype6-dev \
          libx11-dev \
          libx11-xcb-dev \
          libxext-dev \
          libxfixes-dev \
          libxi-dev \
          libxrender-dev \
          libxcb1-dev \
          libxcb-glx0-dev \
          libxcb-util0-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          librsvg2-bin
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.3'
        target: 'desktop'
        arch: 'linux_gcc_64'
        cache: true
        install-deps: true
    
    - name: Verify installation
      run: |
        echo "=== Qt Version ==="
        qmake --version
        
        echo -e "\n=== GCC Compiler ==="
        gcc --version
        
        echo -e "\n=== Ninja ==="
        ninja --version
        
        echo -e "\n=== CMake ==="
        cmake --version
    
    - name: Configure CMake
      run: |
        cmake -S . -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}" \
          -DCMAKE_INSTALL_PREFIX=/opt/nst \
          -DQT_DEPLOY_SUPPORT=OFF \
          -DSKIP_QT_DEPLOY=ON
        
        echo -e "\n=== CMake Configuration ==="
        echo "Build Type: Release"
        echo "Install Prefix: /opt/nst"
    
    - name: Build
      run: cmake --build build --config Release --parallel $(nproc)
    
    - name: Verify build output
      run: |
        echo "=== Build directory structure ==="
        find build -name "*.so" -o -name "NST" -type f
        echo ""
        echo "=== Checking library locations ==="
        ls -la build/BGA/ || true
        ls -la build/QtLingo/ || true
    
    - name: Install to staging directory
      run: |
        mkdir -p AppDir/opt/nst/bin
        mkdir -p AppDir/opt/nst/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
        
        cd build
        
        install -D -m 755 NST ../AppDir/opt/nst/bin/NST
        install -D -m 755 BGA/libBGACore.so ../AppDir/opt/nst/lib/libBGACore.so
        install -D -m 755 QtLingo/libQtLingo.so ../AppDir/opt/nst/lib/libQtLingo.so
        
        cd ..
        
        install -D -m 644 packaging/debian/nst.desktop AppDir/usr/share/applications/nst.desktop
        install -D -m 644 packaging/icons/nst.svg AppDir/usr/share/icons/hicolor/scalable/apps/nst.svg
        
        # Update desktop file to use /opt/nst path
        sed -i 's|Exec=NST|Exec=/opt/nst/bin/NST|g' AppDir/usr/share/applications/nst.desktop
        
        echo "Installation completed, checking files..."
        ls -la AppDir/opt/nst/bin/
        echo ""
        ls -la AppDir/opt/nst/lib/
        echo ""
        echo "Desktop file:"
        ls -la AppDir/usr/share/applications/
        echo ""
        echo "Icon:"
        ls -la AppDir/usr/share/icons/hicolor/scalable/apps/
    
    - name: Prepare AppDir structure
      run: |
        cd AppDir
        
        if [ ! -f "opt/nst/bin/NST" ]; then
          echo "Error: NST binary not found at opt/nst/bin/NST"
          echo "Contents of AppDir:"
          find . -type f
          exit 1
        fi
        
        echo "Found NST binary at: opt/nst/bin/NST"
        
        if [ -f "usr/share/icons/hicolor/scalable/apps/nst.svg" ]; then
          echo "Converting SVG icon to PNG sizes..."
          mkdir -p usr/share/icons/hicolor/256x256/apps
          mkdir -p usr/share/icons/hicolor/128x128/apps
          
          rsvg-convert -w 256 -h 256 \
            usr/share/icons/hicolor/scalable/apps/nst.svg \
            -o usr/share/icons/hicolor/256x256/apps/nst.png
          
          rsvg-convert -w 128 -h 128 \
            usr/share/icons/hicolor/scalable/apps/nst.svg \
            -o usr/share/icons/hicolor/128x128/apps/nst.png
            
          echo "Icon conversion completed"
        fi
        
        if [ ! -f "usr/share/applications/nst.desktop" ]; then
          echo "Error: Desktop file not found"
          exit 1
        fi
        
        sed -i 's/Categories=.*/Categories=Development;/' usr/share/applications/nst.desktop
        
        echo "Desktop file fixed"
        
        cat > AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/opt/nst/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/opt/nst/lib:${LD_LIBRARY_PATH}"
        export QT_PLUGIN_PATH="${HERE}/opt/nst/plugins"
        export QML_IMPORT_PATH="${HERE}/opt/nst/qml"
        export QML2_IMPORT_PATH="${HERE}/opt/nst/qml"
        exec "${HERE}/opt/nst/bin/NST" "$@"
        EOF
        chmod +x AppRun
        
        ln -sf usr/share/applications/nst.desktop nst.desktop
        
        if [ -f usr/share/icons/hicolor/256x256/apps/nst.png ]; then
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png nst.png
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png .DirIcon
          echo "Created icon symlinks (256x256 PNG)"
        elif [ -f usr/share/icons/hicolor/scalable/apps/nst.svg ]; then
          ln -sf usr/share/icons/hicolor/scalable/apps/nst.svg nst.svg
          echo "Created icon symlinks (SVG fallback)"
        else
          echo "Warning: No icon found!"
        fi
        
        echo -e "\n=== AppDir structure created ==="
        ls -la
        echo -e "\n=== Icon files ==="
        find usr/share/icons -name "nst.*"
    
    - name: Deploy Qt dependencies
      run: |
        cd AppDir
        
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        
        wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy-plugin-qt-x86_64.AppImage
        
        # Set environment for linuxdeploy to use /opt/nst structure
        export DEPLOY_PREFIX=/opt/nst
        
        echo "Deploying Qt dependencies to /opt/nst..."
        ./linuxdeploy-x86_64.AppImage \
          --appdir . \
          --executable opt/nst/bin/NST \
          --library opt/nst/lib/libBGACore.so \
          --library opt/nst/lib/libQtLingo.so \
          --plugin qt \
          --output appimage || true
        
        # Move Qt files from usr to opt/nst if linuxdeploy put them in usr
        if [ -d "usr/lib" ]; then
          mkdir -p opt/nst/lib
          cp -r usr/lib/* opt/nst/lib/ 2>/dev/null || true
        fi
        
        if [ -d "usr/plugins" ]; then
          mkdir -p opt/nst/plugins
          cp -r usr/plugins/* opt/nst/plugins/ 2>/dev/null || true
        fi
        
        if [ -d "usr/qml" ]; then
          mkdir -p opt/nst/qml
          cp -r usr/qml/* opt/nst/qml/ 2>/dev/null || true
        fi
        
        echo -e "\n=== Deployment completed ==="
        echo "Libraries in opt/nst/lib:"
        ls -lh opt/nst/lib/ | head -20
    
    - name: Create AppImage
      run: |
        cd AppDir
        
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        
        ./appimagetool-x86_64.AppImage --appimage-extract
        
        ARCH=x86_64 ./squashfs-root/AppRun . ../NST-0.4.3-x86_64.AppImage
        
        cd ..
        chmod +x NST-0.4.3-x86_64.AppImage
        
        echo -e "\n=== AppImage created ==="
        ls -lh NST-0.4.3-x86_64.AppImage
        
        ./NST-0.4.3-x86_64.AppImage --version || echo "Version check skipped"
    
    - name: Create tar.gz archive
      run: |
        mkdir -p package-tar/NST-0.4.3
        cd AppDir
        
        cp -r usr ../package-tar/NST-0.4.3/
        cp AppRun ../package-tar/NST-0.4.3/
        
        cd ../package-tar
        
        cat > NST-0.4.3/README.txt << 'EOF'
        NST v0.4.3 - A tool for translating video games
        ================================================
        
        Installation:
        -------------
        Run: sudo ./install.sh
        
        This will copy files to:
        - /opt/nst/ (application directory)
        - /usr/share/applications/nst.desktop (desktop entry)
        - /usr/share/icons/ (application icon)
        - /usr/local/bin/nst (symbolic link for terminal access)
        
        Uninstallation:
        ---------------
        Run: sudo ./uninstall.sh
        
        Manual Run (without installation):
        -----------------------------------
        ./AppRun
        
        Requirements:
        -------------
        - Linux x86_64
        - glibc 2.31+
        - libGL, libxcb, libxkbcommon
        EOF
        
        cat > NST-0.4.3/install.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "Installing NST v0.4.3..."
        
        if [ "$EUID" -ne 0 ]; then 
            echo "Please run as root (use sudo)"
            exit 1
        fi
        
        echo "Copying files..."
        mkdir -p /opt/nst
        cp -r opt/nst/* /opt/nst/
        
        cp -r usr/share/* /usr/share/
        
        # Create symbolic link in /usr/local/bin for easy terminal access
        mkdir -p /usr/local/bin
        ln -sf /opt/nst/bin/NST /usr/local/bin/nst
        
        chmod +x /opt/nst/bin/NST
        chmod +x /opt/nst/lib/*.so* 2>/dev/null || true
        
        if command -v update-desktop-database >/dev/null 2>&1; then
            echo "Updating desktop database..."
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            echo "Updating icon cache..."
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        echo ""
        echo "Installation complete!"
        echo "You can now run:"
        echo "  - 'nst' from terminal"
        echo "  - Or find 'NST' in your applications menu"
        echo ""
        echo "All application files are in: /opt/nst"
        EOF
        chmod +x NST-0.4.3/install.sh
        
        cat > NST-0.4.3/uninstall.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "Uninstalling NST..."
        
        if [ "$EUID" -ne 0 ]; then 
            echo "Please run as root (use sudo)"
            exit 1
        fi
        
        echo "Removing files..."
        rm -rf /opt/nst
        rm -f /usr/local/bin/nst
        rm -f /usr/share/applications/nst.desktop
        rm -f /usr/share/icons/hicolor/*/apps/nst.png
        rm -f /usr/share/icons/hicolor/scalable/apps/nst.svg
        
        if command -v update-desktop-database >/dev/null 2>&1; then
            echo "Updating desktop database..."
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            echo "Updating icon cache..."
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        echo "Uninstallation complete!"
        EOF
        chmod +x NST-0.4.3/uninstall.sh
        
        tar -czf ../NST-0.4.3-Linux-x86_64.tar.gz NST-0.4.3/
        cd ..
        
        echo -e "\n=== tar.gz created ==="
        ls -lh NST-0.4.3-Linux-x86_64.tar.gz
    
    - name: Create DEB package
      run: |
        mkdir -p nst-deb/DEBIAN
        mkdir -p nst-deb/opt
        mkdir -p nst-deb/usr/share
        mkdir -p nst-deb/usr/local/bin
        
        cp -r AppDir/opt/* nst-deb/opt/
        cp -r AppDir/usr/share/* nst-deb/usr/share/
        
        cat > nst-deb/DEBIAN/control << 'EOF'
        Package: nst
        Version: 0.4.3
        Section: utils
        Priority: optional
        Architecture: amd64
        Depends: libc6 (>= 2.31), libstdc++6 (>= 10), libgcc1, libgl1, libxcb1, libxkbcommon0, libxkbcommon-x11-0, libfontconfig1, libfreetype6, libdbus-1-3
        Maintainer: NST Ghost <you@example.com>
        Description: A tool for translating video games
         NST is a powerful tool for translating video games.
         It supports various game formats and provides an intuitive
         interface for translation workflows.
         .
         Built with Qt 6.7.3
         .
         Installed to /opt/nst
        EOF
        
        cat > nst-deb/DEBIAN/postinst << 'EOF'
        #!/bin/bash
        set -e
        
        chmod +x /opt/nst/bin/NST || true
        chmod +x /opt/nst/lib/*.so* 2>/dev/null || true
        
        # Create symbolic link
        ln -sf /opt/nst/bin/NST /usr/local/bin/nst 2>/dev/null || true
        
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        exit 0
        EOF
        chmod +x nst-deb/DEBIAN/postinst
        
        cat > nst-deb/DEBIAN/postrm << 'EOF'
        #!/bin/bash
        set -e
        
        rm -f /usr/local/bin/nst 2>/dev/null || true
        
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        exit 0
        EOF
        chmod +x nst-deb/DEBIAN/postrm
        
        dpkg-deb --build nst-deb NST-0.4.3-Linux-x86_64.deb
        
        echo -e "\n=== DEB package created ==="
        ls -lh NST-0.4.3-Linux-x86_64.deb
        dpkg-deb --info NST-0.4.3-Linux-x86_64.deb
        echo -e "\n=== DEB contents ==="
        dpkg-deb --contents NST-0.4.3-Linux-x86_64.deb | head -20
    
    - name: Create RPM package
      run: |
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
        
        mkdir -p nst-rpm-source/nst-0.4.3/opt
        mkdir -p nst-rpm-source/nst-0.4.3/usr/share
        cp -r AppDir/opt/* nst-rpm-source/nst-0.4.3/opt/
        cp -r AppDir/usr/share/* nst-rpm-source/nst-0.4.3/usr/share/
        cd nst-rpm-source
        tar -czf ~/rpmbuild/SOURCES/nst-0.4.3.tar.gz nst-0.4.3/
        cd ..
        
        # Check what directories exist
        echo "=== Checking AppDir structure for RPM ==="
        ls -la AppDir/opt/nst/
        
        # Build file list dynamically
        FILES_LIST="/opt/nst/*
        /usr/share/applications/nst.desktop
        /usr/share/icons/hicolor/*/apps/nst.*"
        
        cat > ~/rpmbuild/SPECS/nst.spec << EOF
        Name:           nst
        Version:        0.4.3
        Release:        1%{?dist}
        Summary:        A tool for translating video games
        
        License:        MIT
        URL:            https://github.com/yourusername/nst
        Source0:        %{name}-%{version}.tar.gz
        
        BuildArch:      x86_64
        
        Requires:       glibc >= 2.31, libstdc++ >= 10, libgcc, libGL, libxcb, libxkbcommon, fontconfig, freetype, dbus-libs
        
        %description
        NST is a powerful tool for translating video games.
        It supports various game formats and provides an intuitive
        interface for translation workflows.
        
        Built with Qt 6.7.3
        
        %prep
        %setup -q
        
        %install
        rm -rf \$RPM_BUILD_ROOT
        mkdir -p \$RPM_BUILD_ROOT
        cp -r opt \$RPM_BUILD_ROOT/
        cp -r usr \$RPM_BUILD_ROOT/
        
        %post
        chmod +x /opt/nst/bin/NST || true
        chmod +x /opt/nst/lib/*.so* 2>/dev/null || true
        
        # Create symbolic link
        mkdir -p /usr/local/bin
        ln -sf /opt/nst/bin/NST /usr/local/bin/nst 2>/dev/null || true
        
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        %postun
        rm -f /usr/local/bin/nst 2>/dev/null || true
        
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi
        
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi
        
        %files
        $FILES_LIST
        
        %changelog
        * Sat Nov 08 2025 NST Ghost <you@example.com> - 0.4.3-1
        - Release version 0.4.3
        - Built with Qt 6.7.3
        EOF
        
        echo "=== Generated RPM spec file ==="
        cat ~/rpmbuild/SPECS/nst.spec
        
        rpmbuild -bb ~/rpmbuild/SPECS/nst.spec
        
        find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} NST-0.4.3-Linux-x86_64.rpm \;
        
        echo -e "\n=== RPM package created ==="
        ls -lh NST-0.4.3-Linux-x86_64.rpm
        rpm -qpi NST-0.4.3-Linux-x86_64.rpm
    
    - name: Verify all packages
      run: |
        echo "=== All packages created ==="
        ls -lh NST-* | grep -E '\.(AppImage|tar\.gz|deb|rpm)$'
        
        echo -e "\n=== Package sizes ==="
        du -h NST-0.4.3-x86_64.AppImage \
               NST-0.4.3-Linux-x86_64.tar.gz \
               NST-0.4.3-Linux-x86_64.deb \
               NST-0.4.3-Linux-x86_64.rpm
        
        echo -e "\n=== Package details ==="
        echo "AppImage: Portable, run directly"
        echo "tar.gz: Manual installation with install.sh"
        echo "DEB: For Debian/Ubuntu (dpkg -i or apt install)"
        echo "RPM: For Fedora/RHEL/CentOS (rpm -i or dnf install)"
    
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: NST-0.4.3-x86_64-AppImage
        path: NST-0.4.3-x86_64.AppImage
        if-no-files-found: error
    
    - name: Upload tar.gz
      uses: actions/upload-artifact@v4
      with:
        name: NST-0.4.3-Linux-x86_64-tar
        path: NST-0.4.3-Linux-x86_64.tar.gz
        if-no-files-found: error
    
    - name: Upload DEB
      uses: actions/upload-artifact@v4
      with:
        name: NST-0.4.3-Linux-x86_64-deb
        path: NST-0.4.3-Linux-x86_64.deb
        if-no-files-found: error
    
    - name: Upload RPM
      uses: actions/upload-artifact@v4
      with:
        name: NST-0.4.3-Linux-x86_64-rpm
        path: NST-0.4.3-Linux-x86_64.rpm
        if-no-files-found: error
