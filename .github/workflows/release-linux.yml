name: Build Linux Release

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: 'Version number (e.g., 0.4.3)'
      build_variant:
        required: false
        type: string
        default: 'full'
        description: 'Build variant: core (no Python) or full (with Python)'

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxcb-shape0 \
            libfuse2 \
            file \
            rpm \
            patchelf \
            desktop-file-utils \
            libfontconfig1-dev \
            libfreetype6-dev \
            libx11-dev \
            libx11-xcb-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxrender-dev \
            libxcb1-dev \
            libxcb-glx0-dev \
            libxcb-util0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            librsvg2-bin \
            liblua5.4-dev \
            python3-dev
      
      - name: Install pybind11
        run: |
          pip install pybind11
          echo "pybind11_DIR=$(python3 -m pybind11 --cmakedir)" >> $GITHUB_ENV
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.10.0'
          target: 'desktop'
          arch: 'linux_gcc_64'
          cache: true
          install-deps: true
      
      - name: Configure CMake
        run: |
          # Determine Python flag based on build variant
          if [ "${{ inputs.build_variant }}" = "core" ]; then
            PYTHON_FLAG="-DNST_ENABLE_PYTHON=OFF"
            echo "Building Core variant (no Python)"
          else
            PYTHON_FLAG="-DNST_ENABLE_PYTHON=ON"
            echo "Building Full variant (with Python)"
          fi
          
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }};${{ env.pybind11_DIR }}" \
            -DCMAKE_INSTALL_PREFIX=/opt/nst \
            -DQT_DEPLOY_SUPPORT=OFF \
            -DSKIP_QT_DEPLOY=ON \
            $PYTHON_FLAG
      
      - name: Build
        run: cmake --build build --config Release --parallel $(nproc)
      
      - name: Test
        run: |
          cd build
          ctest --output-on-failure
      
      - name: Install to staging directory
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
          
          cd build
          install -D -m 755 NST ../AppDir/usr/bin/NST
          install -D -m 755 BGA/libBGACore.so ../AppDir/usr/bin/libBGACore.so
          install -D -m 755 QtLingo/libQtLingo.so ../AppDir/usr/bin/libQtLingo.so
          cd ..
          
          # Copy Python scripts
          cp -r scripts AppDir/usr/bin/scripts
          chmod +x AppDir/usr/bin/scripts/install-ai-features.sh
          
          install -D -m 644 packaging/debian/nst.desktop AppDir/usr/share/applications/nst.desktop
          install -D -m 644 packaging/icons/nst.svg AppDir/usr/share/icons/hicolor/scalable/apps/nst.svg
      
      - name: Prepare AppDir structure
        run: |
          cd AppDir
          
          # Convert SVG to PNG
          if [ -f "usr/share/icons/hicolor/scalable/apps/nst.svg" ]; then
            mkdir -p usr/share/icons/hicolor/256x256/apps
            mkdir -p usr/share/icons/hicolor/128x128/apps
            
            rsvg-convert -w 256 -h 256 \
              usr/share/icons/hicolor/scalable/apps/nst.svg \
              -o usr/share/icons/hicolor/256x256/apps/nst.png
            
            rsvg-convert -w 128 -h 128 \
              usr/share/icons/hicolor/scalable/apps/nst.svg \
              -o usr/share/icons/hicolor/128x128/apps/nst.png
          fi
          
          # Fix desktop file
          sed -i 's/Categories=.*/Categories=Development;/' usr/share/applications/nst.desktop
          
          # Create symlinks
          ln -sf usr/share/applications/nst.desktop nst.desktop
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png nst.png
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png .DirIcon
      
      
      # Bundle Python stdlib for embedded interpreter (Full build only)
      - name: Bundle Python stdlib
        if: inputs.build_variant != 'core'
        run: |
          PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          echo "Bundling Python ${PYTHON_VERSION} stdlib"
          
          # Get Python prefix
          PYTHON_PREFIX=$(python3 -c "import sys; print(sys.prefix)")
          
          # Create target directory
          mkdir -p AppDir/usr/lib/python${PYTHON_VERSION}
          
          # Copy stdlib (excluding test directories to save space)
          cp -r ${PYTHON_PREFIX}/lib/python${PYTHON_VERSION}/* AppDir/usr/lib/python${PYTHON_VERSION}/ || true
          
          # Remove test directories and __pycache__ to reduce size
          find AppDir/usr/lib/python${PYTHON_VERSION} -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          find AppDir/usr/lib/python${PYTHON_VERSION} -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find AppDir/usr/lib/python${PYTHON_VERSION} -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find AppDir/usr/lib/python${PYTHON_VERSION} -name "*.pyc" -delete 2>/dev/null || true
          
          # Copy libpython shared library
          if [ -f "${PYTHON_PREFIX}/lib/libpython${PYTHON_VERSION}.so.1.0" ]; then
            cp ${PYTHON_PREFIX}/lib/libpython${PYTHON_VERSION}.so* AppDir/usr/lib/ || true
          elif [ -f "${PYTHON_PREFIX}/lib/libpython${PYTHON_VERSION}.so" ]; then
            cp ${PYTHON_PREFIX}/lib/libpython${PYTHON_VERSION}.so* AppDir/usr/lib/ || true
          fi
          
          echo "Python stdlib bundled successfully"
          ls -la AppDir/usr/lib/python${PYTHON_VERSION}/ | head -20
      
      - name: Bundle NumPy for OpenCV
        if: inputs.build_variant != 'core'
        run: |
          PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          SITE_PACKAGES="AppDir/usr/lib/python${PYTHON_VERSION}/site-packages"
          
          # Install only numpy for OpenCV bindings (AI features installed by user)
          pip install --target="${SITE_PACKAGES}" numpy
          
          echo "NumPy bundled successfully"
      
      - name: Create AppRun script
        run: |
          cd AppDir
          
          cat > AppRun << 'APPRUN_EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          
          # Set APPDIR for C++ code
          export APPDIR="${HERE}"
          
          # --- PEP668 Compliant Python Setup ---
          # Following Fedora/modern distro principles:
          # - Do NOT set PYTHONHOME (causes conflicts with pyenv, conda, etc.)
          # - Let the system Python manage its own configuration
          # - Only add our scripts to PYTHONPATH
          
          # Find system Python library directory for LD_LIBRARY_PATH
          # Try /usr/bin/python3 first to avoid pyenv/conda shims
          SYSTEM_PYTHON=""
          for py in /usr/bin/python3 /usr/bin/python $(which python3 2>/dev/null) $(which python 2>/dev/null); do
              if [ -x "$py" ] && [ ! -L "$py" ] || [ -x "$py" ]; then
                  # Verify it's a real Python, not a shim
                  if "$py" -c "import sys; sys.exit(0)" 2>/dev/null; then
                      SYSTEM_PYTHON="$py"
                      break
                  fi
              fi
          done
          
          PY_LIB_DIR=""
          if [ -n "$SYSTEM_PYTHON" ]; then
              PY_PREFIX=$("$SYSTEM_PYTHON" -c "import sys; print(sys.prefix)" 2>/dev/null)
              if [ -d "${PY_PREFIX}/lib" ]; then
                  PY_LIB_DIR="${PY_PREFIX}/lib"
              elif [ -d "${PY_PREFIX}/lib64" ]; then
                  PY_LIB_DIR="${PY_PREFIX}/lib64"
              fi
          fi
          
          # Standard paths
          export PATH="${HERE}/usr/bin:${PATH}"
          
          # Add Python lib dir to LD_LIBRARY_PATH for libpython discovery
          if [ -n "$PY_LIB_DIR" ]; then
              export LD_LIBRARY_PATH="${PY_LIB_DIR}:${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${HERE}/usr/bin:${LD_LIBRARY_PATH}"
          else
              export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${HERE}/usr/bin:${LD_LIBRARY_PATH}"
          fi
          
          # Qt plugin paths
          export QT_PLUGIN_PATH="${HERE}/usr/plugins"
          export QML_IMPORT_PATH="${HERE}/usr/qml"
          export QML2_IMPORT_PATH="${HERE}/usr/qml"
          
          # Add application bin dir to PYTHONPATH so "import scripts" works (scripts is a subdir)
          export PYTHONPATH="${HERE}/usr/bin:${PYTHONPATH}"
          
          exec "${HERE}/usr/bin/NST" "$@"
          APPRUN_EOF
          
          chmod +x AppRun
      
      - name: Deploy Qt dependencies
        run: |
          cd AppDir
          
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-plugin-qt-x86_64.AppImage
          
          ./linuxdeploy-x86_64.AppImage --appdir . --plugin qt || true
      
      - name: Add Qt Wayland plugins
        run: |
          QT_PLUGIN_DIR=$(qtpaths6 --plugin-dir 2>/dev/null || echo "${{ env.Qt6_DIR }}/plugins")
          mkdir -p AppDir/usr/plugins/platforms
          
          for f in libqwayland-egl.so libqwayland-generic.so libqwayland-xcomposite-egl.so libqwayland-xcomposite-glx.so; do
            if [ -f "${QT_PLUGIN_DIR}/platforms/$f" ]; then
              cp "${QT_PLUGIN_DIR}/platforms/$f" AppDir/usr/plugins/platforms/
            fi
          done
      
      - name: Create AppImage
        run: |
          cd AppDir
          
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --appimage-extract
          
          ARCH=x86_64 ./squashfs-root/AppRun . ../NST-${{ inputs.version }}-x86_64.AppImage
          cd ..
          chmod +x NST-${{ inputs.version }}-x86_64.AppImage
      
      - name: Create tar.gz archive
        run: |
          mkdir -p package-tar/NST-${{ inputs.version }}
          cd AppDir
          
          cp -r usr ../package-tar/NST-${{ inputs.version }}/
          cp AppRun ../package-tar/NST-${{ inputs.version }}/
          
          cd ../package-tar
          
          cat > NST-${{ inputs.version }}/README.txt << 'EOF'
          NST v${{ inputs.version }} - A tool for translating video games
          
          Installation: Run sudo ./install.sh
          Uninstallation: Run sudo ./uninstall.sh
          Manual Run: ./AppRun
          EOF
          
          cat > NST-${{ inputs.version }}/install.sh << 'EOF'
          #!/bin/bash
          set -e
          if [ "$EUID" -ne 0 ]; then
              echo "Please run as root (use sudo)"
              exit 1
          fi
          cp -r usr/* /usr/
          chmod +x /usr/bin/NST
          chmod +x /usr/bin/libBGACore.so* 2>/dev/null || true
          chmod +x /usr/bin/libQtLingo.so* 2>/dev/null || true
          update-desktop-database /usr/share/applications 2>/dev/null || true
          gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          echo "Installation complete!"
          EOF
          chmod +x NST-${{ inputs.version }}/install.sh
          
          cat > NST-${{ inputs.version }}/uninstall.sh << 'EOF'
          #!/bin/bash
          set -e
          if [ "$EUID" -ne 0 ]; then
              echo "Please run as root (use sudo)"
              exit 1
          fi
          rm -f /usr/bin/NST /usr/bin/libBGACore.so* /usr/bin/libQtLingo.so*
          rm -f /usr/share/applications/nst.desktop
          rm -f /usr/share/icons/hicolor/*/apps/nst.*
          update-desktop-database /usr/share/applications 2>/dev/null || true
          gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          echo "Uninstallation complete!"
          EOF
          chmod +x NST-${{ inputs.version }}/uninstall.sh
          
          tar -czf ../NST-${{ inputs.version }}-Linux-x86_64.tar.gz NST-${{ inputs.version }}/
      
      - name: Create DEB package
        run: |
          mkdir -p nst-deb/DEBIAN nst-deb/usr
          cp -r AppDir/usr/* nst-deb/usr/
          
          cat > nst-deb/DEBIAN/control << EOF
          Package: nst
          Version: ${{ inputs.version }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libc6 (>= 2.31), libstdc++6 (>= 10), libgl1, libxcb1, libxkbcommon0
          Maintainer: NST Team <you@example.com>
          Description: A tool for translating video games
          EOF
          
          cat > nst-deb/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          chmod +x /usr/bin/NST /usr/bin/libBGACore.so* /usr/bin/libQtLingo.so* 2>/dev/null || true
          update-desktop-database /usr/share/applications 2>/dev/null || true
          gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          exit 0
          EOF
          chmod +x nst-deb/DEBIAN/postinst
          
          dpkg-deb --build nst-deb NST-${{ inputs.version }}-Linux-x86_64.deb
      
      - name: Create RPM package
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p nst-rpm-source/nst-${{ inputs.version }}/usr
          cp -r AppDir/usr/* nst-rpm-source/nst-${{ inputs.version }}/usr/
          cd nst-rpm-source
          tar -czf ~/rpmbuild/SOURCES/nst-${{ inputs.version }}.tar.gz nst-${{ inputs.version }}/
          cd ..
          
          echo "=== Checking AppDir structure for RPM ==="
          ls -la AppDir/usr/ || true
          
          # Build files list dynamically based on what exists
          FILES_LIST="/usr/bin/*
          /usr/share/applications/nst.desktop
          /usr/share/icons/hicolor/*/apps/nst.*"
          
          # Check for optional directories
          if [ -d "AppDir/usr/lib" ] && [ "$(ls -A AppDir/usr/lib 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          %dir /usr/lib
          /usr/lib/*"
          fi
          
          if [ -d "AppDir/usr/plugins" ] && [ "$(ls -A AppDir/usr/plugins 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          %dir /usr/plugins
          /usr/plugins/*"
          fi
          
          if [ -d "AppDir/usr/qml" ] && [ "$(ls -A AppDir/usr/qml 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          %dir /usr/qml
          /usr/qml/*"
          fi
          
          if [ -d "AppDir/usr/translations" ] && [ "$(ls -A AppDir/usr/translations 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          %dir /usr/translations
          /usr/translations/*"
          fi
          
          if [ -d "AppDir/usr/share/doc" ] && [ "$(ls -A AppDir/usr/share/doc 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          /usr/share/doc/*"
          fi
          

          # Python is no longer bundled - dependencies are system-based

          
          echo "=== Files to include in RPM ==="
          echo "$FILES_LIST"
          
          cat > ~/rpmbuild/SPECS/nst.spec << EOF
          Name: nst
          Version: ${{ inputs.version }}
          Release: 1%{?dist}
          Summary: A tool for translating video games
          License: MIT
          URL: https://github.com/${{ github.repository }}
          Source0: %{name}-%{version}.tar.gz
          BuildArch: x86_64
          Requires: glibc >= 2.31, libstdc++ >= 10, libGL, libxcb, libxkbcommon, fontconfig, freetype, dbus-libs
          
          %description
          NST is a tool for translating video games.
          It supports various game formats and provides an intuitive
          interface for translation workflows.
          
          %prep
          %setup -q
          
          %install
          rm -rf \$RPM_BUILD_ROOT
          mkdir -p \$RPM_BUILD_ROOT
          cp -r usr \$RPM_BUILD_ROOT/
          
          %post
          chmod +x /usr/bin/NST 2>/dev/null || true
          chmod +x /usr/bin/libBGACore.so* 2>/dev/null || true
          chmod +x /usr/bin/libQtLingo.so* 2>/dev/null || true
          if command -v update-desktop-database >/dev/null 2>&1; then
              update-desktop-database /usr/share/applications 2>/dev/null || true
          fi
          if command -v gtk-update-icon-cache >/dev/null 2>&1; then
              gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          fi
          
          %postun
          if command -v update-desktop-database >/dev/null 2>&1; then
              update-desktop-database /usr/share/applications 2>/dev/null || true
          fi
          if command -v gtk-update-icon-cache >/dev/null 2>&1; then
              gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          fi
          
          %files
          $FILES_LIST
          
          %changelog
          * $(date "+%a %b %d %Y") NST Team <you@example.com> - ${{ inputs.version }}-1
          - Release version ${{ inputs.version }}
          EOF
          
          echo "=== Generated RPM spec file ==="
          cat ~/rpmbuild/SPECS/nst.spec
          
          rpmbuild -bb ~/rpmbuild/SPECS/nst.spec
          find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} NST-${{ inputs.version }}-Linux-x86_64.rpm \;
      
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-x86_64-AppImage
          path: NST-${{ inputs.version }}-x86_64.AppImage
          if-no-files-found: error
      
      - name: Upload tar.gz
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-Linux-x86_64-tar
          path: NST-${{ inputs.version }}-Linux-x86_64.tar.gz
          if-no-files-found: error
      
      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-Linux-x86_64-deb
          path: NST-${{ inputs.version }}-Linux-x86_64.deb
          if-no-files-found: error
      
      - name: Upload RPM
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-Linux-x86_64-rpm
          path: NST-${{ inputs.version }}-Linux-x86_64.rpm
          if-no-files-found: error
