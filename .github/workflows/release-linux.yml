name: Build Linux Release

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: 'Version number (e.g., 0.4.3)'

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxcb-shape0 \
            libfuse2 \
            file \
            rpm \
            patchelf \
            desktop-file-utils \
            libfontconfig1-dev \
            libfreetype6-dev \
            libx11-dev \
            libx11-xcb-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxrender-dev \
            libxcb1-dev \
            libxcb-glx0-dev \
            libxcb-util0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            librsvg2-bin \
            liblua5.4-dev \
            python3-dev
      
      - name: Install pybind11
        run: |
          pip install pybind11
          echo "pybind11_DIR=$(python3 -m pybind11 --cmakedir)" >> $GITHUB_ENV
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.10.0'
          target: 'desktop'
          arch: 'linux_gcc_64'
          cache: true
          install-deps: true
      
      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }};${{ env.pybind11_DIR }}" \
            -DCMAKE_INSTALL_PREFIX=/opt/nst \
            -DQT_DEPLOY_SUPPORT=OFF \
            -DSKIP_QT_DEPLOY=ON
      
      - name: Build
        run: cmake --build build --config Release --parallel $(nproc)
      
      - name: Test
        run: |
          cd build
          ctest --output-on-failure
      
      - name: Install to staging directory
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
          
          cd build
          install -D -m 755 NST ../AppDir/usr/bin/NST
          install -D -m 755 BGA/libBGACore.so ../AppDir/usr/bin/libBGACore.so
          install -D -m 755 QtLingo/libQtLingo.so ../AppDir/usr/bin/libQtLingo.so
          cd ..
          
          # Copy Python scripts
          cp -r scripts AppDir/usr/bin/scripts
          
          install -D -m 644 packaging/debian/nst.desktop AppDir/usr/share/applications/nst.desktop
          install -D -m 644 packaging/icons/nst.svg AppDir/usr/share/icons/hicolor/scalable/apps/nst.svg
      
      - name: Prepare AppDir structure
        run: |
          cd AppDir
          
          # Convert SVG to PNG
          if [ -f "usr/share/icons/hicolor/scalable/apps/nst.svg" ]; then
            mkdir -p usr/share/icons/hicolor/256x256/apps
            mkdir -p usr/share/icons/hicolor/128x128/apps
            
            rsvg-convert -w 256 -h 256 \
              usr/share/icons/hicolor/scalable/apps/nst.svg \
              -o usr/share/icons/hicolor/256x256/apps/nst.png
            
            rsvg-convert -w 128 -h 128 \
              usr/share/icons/hicolor/scalable/apps/nst.svg \
              -o usr/share/icons/hicolor/128x128/apps/nst.png
          fi
          
          # Fix desktop file
          sed -i 's/Categories=.*/Categories=Development;/' usr/share/applications/nst.desktop
          
          # Create symlinks
          ln -sf usr/share/applications/nst.desktop nst.desktop
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png nst.png
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png .DirIcon
      
      - name: Bundle Python distribution
        run: |
          cd AppDir
          
          # Find Python version and paths
          PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          PYTHON_PREFIX=$(python3 -c "import sys; print(sys.prefix)")
          
          echo "Python version: ${PYTHON_VERSION}"
          echo "Python prefix: ${PYTHON_PREFIX}"
          
          # Create proper Python directory structure
          mkdir -p usr/python/lib/python${PYTHON_VERSION}
          mkdir -p usr/python/lib/python${PYTHON_VERSION}/site-packages
          
          # Copy Python stdlib
          cp -r ${PYTHON_PREFIX}/lib/python${PYTHON_VERSION}/* usr/python/lib/python${PYTHON_VERSION}/ 2>/dev/null || true
          
          # Copy libpython shared library
          if [ -f "${PYTHON_PREFIX}/lib/libpython${PYTHON_VERSION}.so.1.0" ]; then
            cp ${PYTHON_PREFIX}/lib/libpython${PYTHON_VERSION}.so* usr/python/lib/
          elif [ -f "${PYTHON_PREFIX}/lib/libpython${PYTHON_VERSION}.so" ]; then
            cp ${PYTHON_PREFIX}/lib/libpython${PYTHON_VERSION}.so* usr/python/lib/
          fi
          
          # Remove unnecessary directories to reduce size
          rm -rf usr/python/lib/python${PYTHON_VERSION}/test
          rm -rf usr/python/lib/python${PYTHON_VERSION}/tests
          rm -rf usr/python/lib/python${PYTHON_VERSION}/unittest/test
          rm -rf usr/python/lib/python${PYTHON_VERSION}/idlelib
          rm -rf usr/python/lib/python${PYTHON_VERSION}/tkinter
          rm -rf usr/python/lib/python${PYTHON_VERSION}/turtle*
          rm -rf usr/python/lib/python${PYTHON_VERSION}/turtledemo
          find usr/python/lib/python${PYTHON_VERSION} -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find usr/python/lib/python${PYTHON_VERSION} -name "*.pyc" -delete 2>/dev/null || true
          
          # Save Python version for reference
          echo "${PYTHON_VERSION}" > .python_version
          
          echo "Python distribution bundled successfully"
          du -sh usr/python/ || true
      
      - name: Create AppRun script
        run: |
          cd AppDir
          PYTHON_VERSION=$(cat .python_version)
          
          cat > AppRun << 'APPRUN_EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          
          # Standard paths
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${HERE}/usr/bin:${HERE}/usr/python/lib:${LD_LIBRARY_PATH}"
          
          # Qt plugin paths
          export QT_PLUGIN_PATH="${HERE}/usr/plugins"
          export QML_IMPORT_PATH="${HERE}/usr/qml"
          export QML2_IMPORT_PATH="${HERE}/usr/qml"
          
          # Python: PYTHONHOME points to bundled Python, add scripts to PYTHONPATH
          # Note: PYTHONHOME is set in C++ code via Py_SetPythonHome when $APPDIR is detected
          export PYTHONPATH="${HERE}/usr/bin:${PYTHONPATH}"
          
          exec "${HERE}/usr/bin/NST" "$@"
          APPRUN_EOF
          
          chmod +x AppRun
      
      - name: Deploy Qt dependencies
        run: |
          cd AppDir
          
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-plugin-qt-x86_64.AppImage
          
          ./linuxdeploy-x86_64.AppImage --appdir . --plugin qt || true
      
      - name: Add Qt Wayland plugins
        run: |
          QT_PLUGIN_DIR=$(qtpaths6 --plugin-dir 2>/dev/null || echo "${{ env.Qt6_DIR }}/plugins")
          mkdir -p AppDir/usr/plugins/platforms
          
          for f in libqwayland-egl.so libqwayland-generic.so libqwayland-xcomposite-egl.so libqwayland-xcomposite-glx.so; do
            if [ -f "${QT_PLUGIN_DIR}/platforms/$f" ]; then
              cp "${QT_PLUGIN_DIR}/platforms/$f" AppDir/usr/plugins/platforms/
            fi
          done
      
      - name: Create AppImage
        run: |
          cd AppDir
          
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --appimage-extract
          
          ARCH=x86_64 ./squashfs-root/AppRun . ../NST-${{ inputs.version }}-x86_64.AppImage
          cd ..
          chmod +x NST-${{ inputs.version }}-x86_64.AppImage
      
      - name: Create tar.gz archive
        run: |
          mkdir -p package-tar/NST-${{ inputs.version }}
          cd AppDir
          
          cp -r usr ../package-tar/NST-${{ inputs.version }}/
          cp AppRun ../package-tar/NST-${{ inputs.version }}/
          
          cd ../package-tar
          
          cat > NST-${{ inputs.version }}/README.txt << 'EOF'
          NST v${{ inputs.version }} - A tool for translating video games
          
          Installation: Run sudo ./install.sh
          Uninstallation: Run sudo ./uninstall.sh
          Manual Run: ./AppRun
          EOF
          
          cat > NST-${{ inputs.version }}/install.sh << 'EOF'
          #!/bin/bash
          set -e
          if [ "$EUID" -ne 0 ]; then
              echo "Please run as root (use sudo)"
              exit 1
          fi
          cp -r usr/* /usr/
          chmod +x /usr/bin/NST
          chmod +x /usr/bin/libBGACore.so* 2>/dev/null || true
          chmod +x /usr/bin/libQtLingo.so* 2>/dev/null || true
          update-desktop-database /usr/share/applications 2>/dev/null || true
          gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          echo "Installation complete!"
          EOF
          chmod +x NST-${{ inputs.version }}/install.sh
          
          cat > NST-${{ inputs.version }}/uninstall.sh << 'EOF'
          #!/bin/bash
          set -e
          if [ "$EUID" -ne 0 ]; then
              echo "Please run as root (use sudo)"
              exit 1
          fi
          rm -f /usr/bin/NST /usr/bin/libBGACore.so* /usr/bin/libQtLingo.so*
          rm -f /usr/share/applications/nst.desktop
          rm -f /usr/share/icons/hicolor/*/apps/nst.*
          update-desktop-database /usr/share/applications 2>/dev/null || true
          gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          echo "Uninstallation complete!"
          EOF
          chmod +x NST-${{ inputs.version }}/uninstall.sh
          
          tar -czf ../NST-${{ inputs.version }}-Linux-x86_64.tar.gz NST-${{ inputs.version }}/
      
      - name: Create DEB package
        run: |
          mkdir -p nst-deb/DEBIAN nst-deb/usr
          cp -r AppDir/usr/* nst-deb/usr/
          
          cat > nst-deb/DEBIAN/control << EOF
          Package: nst
          Version: ${{ inputs.version }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libc6 (>= 2.31), libstdc++6 (>= 10), libgl1, libxcb1, libxkbcommon0
          Maintainer: NST Team <you@example.com>
          Description: A tool for translating video games
          EOF
          
          cat > nst-deb/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          chmod +x /usr/bin/NST /usr/bin/libBGACore.so* /usr/bin/libQtLingo.so* 2>/dev/null || true
          update-desktop-database /usr/share/applications 2>/dev/null || true
          gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          exit 0
          EOF
          chmod +x nst-deb/DEBIAN/postinst
          
          dpkg-deb --build nst-deb NST-${{ inputs.version }}-Linux-x86_64.deb
      
      - name: Create RPM package
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p nst-rpm-source/nst-${{ inputs.version }}/usr
          cp -r AppDir/usr/* nst-rpm-source/nst-${{ inputs.version }}/usr/
          cd nst-rpm-source
          tar -czf ~/rpmbuild/SOURCES/nst-${{ inputs.version }}.tar.gz nst-${{ inputs.version }}/
          cd ..
          
          echo "=== Checking AppDir structure for RPM ==="
          ls -la AppDir/usr/ || true
          
          # Build files list dynamically based on what exists
          FILES_LIST="/usr/bin/*
          /usr/share/applications/nst.desktop
          /usr/share/icons/hicolor/*/apps/nst.*"
          
          # Check for optional directories
          if [ -d "AppDir/usr/lib" ] && [ "$(ls -A AppDir/usr/lib 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          %dir /usr/lib
          /usr/lib/*"
          fi
          
          if [ -d "AppDir/usr/plugins" ] && [ "$(ls -A AppDir/usr/plugins 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          %dir /usr/plugins
          /usr/plugins/*"
          fi
          
          if [ -d "AppDir/usr/qml" ] && [ "$(ls -A AppDir/usr/qml 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          %dir /usr/qml
          /usr/qml/*"
          fi
          
          if [ -d "AppDir/usr/translations" ] && [ "$(ls -A AppDir/usr/translations 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          %dir /usr/translations
          /usr/translations/*"
          fi
          
          if [ -d "AppDir/usr/share/doc" ] && [ "$(ls -A AppDir/usr/share/doc 2>/dev/null)" ]; then
            FILES_LIST="$FILES_LIST
          /usr/share/doc/*"
          fi
          
          echo "=== Files to include in RPM ==="
          echo "$FILES_LIST"
          
          cat > ~/rpmbuild/SPECS/nst.spec << EOF
          Name: nst
          Version: ${{ inputs.version }}
          Release: 1%{?dist}
          Summary: A tool for translating video games
          License: MIT
          URL: https://github.com/${{ github.repository }}
          Source0: %{name}-%{version}.tar.gz
          BuildArch: x86_64
          Requires: glibc >= 2.31, libstdc++ >= 10, libGL, libxcb, libxkbcommon, fontconfig, freetype, dbus-libs
          
          %description
          NST is a tool for translating video games.
          It supports various game formats and provides an intuitive
          interface for translation workflows.
          
          %prep
          %setup -q
          
          %install
          rm -rf \$RPM_BUILD_ROOT
          mkdir -p \$RPM_BUILD_ROOT
          cp -r usr \$RPM_BUILD_ROOT/
          
          %post
          chmod +x /usr/bin/NST 2>/dev/null || true
          chmod +x /usr/bin/libBGACore.so* 2>/dev/null || true
          chmod +x /usr/bin/libQtLingo.so* 2>/dev/null || true
          if command -v update-desktop-database >/dev/null 2>&1; then
              update-desktop-database /usr/share/applications 2>/dev/null || true
          fi
          if command -v gtk-update-icon-cache >/dev/null 2>&1; then
              gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          fi
          
          %postun
          if command -v update-desktop-database >/dev/null 2>&1; then
              update-desktop-database /usr/share/applications 2>/dev/null || true
          fi
          if command -v gtk-update-icon-cache >/dev/null 2>&1; then
              gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          fi
          
          %files
          $FILES_LIST
          
          %changelog
          * $(date "+%a %b %d %Y") NST Team <you@example.com> - ${{ inputs.version }}-1
          - Release version ${{ inputs.version }}
          EOF
          
          echo "=== Generated RPM spec file ==="
          cat ~/rpmbuild/SPECS/nst.spec
          
          rpmbuild -bb ~/rpmbuild/SPECS/nst.spec
          find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} NST-${{ inputs.version }}-Linux-x86_64.rpm \;
      
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-x86_64-AppImage
          path: NST-${{ inputs.version }}-x86_64.AppImage
          if-no-files-found: error
      
      - name: Upload tar.gz
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-Linux-x86_64-tar
          path: NST-${{ inputs.version }}-Linux-x86_64.tar.gz
          if-no-files-found: error
      
      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-Linux-x86_64-deb
          path: NST-${{ inputs.version }}-Linux-x86_64.deb
          if-no-files-found: error
      
      - name: Upload RPM
        uses: actions/upload-artifact@v4
        with:
          name: NST-${{ inputs.version }}-Linux-x86_64-rpm
          path: NST-${{ inputs.version }}-Linux-x86_64.rpm
          if-no-files-found: error
