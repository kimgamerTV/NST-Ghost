name: Build NST Linux
on: [push, pull_request]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libgl1-mesa-dev libfuse2 rpm patchelf desktop-file-utils librsvg2-bin

      - name: Install Qt 6.7.3
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          target: 'desktop'
          arch: 'linux_gcc_64'
          cache: true
          install-deps: true

      - name: Build
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}"
          cmake --build build --parallel $(nproc)

      - name: Stage AppDir
        run: |
          mkdir -p AppDir/opt/nst/{bin,lib} AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/scalable/apps
          install -m 755 build/NST AppDir/opt/nst/bin/
          install -m 755 build/BGA/libBGACore.so build/QtLingo/libQtLingo.so AppDir/opt/nst/lib/
          install -m 644 packaging/debian/nst.desktop AppDir/usr/share/applications/
          install -m 644 packaging/icons/nst.svg AppDir/usr/share/icons/hicolor/scalable/apps/
          sed -i 's|Exec=NST|Exec=/opt/nst/bin/NST|g' AppDir/usr/share/applications/nst.desktop

      - name: Icons
        run: |
          cd AppDir
          mkdir -p usr/share/icons/hicolor/{128x128,256x256}/apps
          rsvg-convert -w 256 -h 256 usr/share/icons/hicolor/scalable/apps/nst.svg -o usr/share/icons/hicolor/256x256/apps/nst.png
          rsvg-convert -w 128 -h 128 usr/share/icons/hicolor/scalable/apps/nst.svg -o usr/share/icons/hicolor/128x128/apps/nst.png

      - name: Deploy Qt (FINAL FIX - GUARANTEED WORKING)
        run: |
          cd AppDir
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

          export QMAKE="${{ env.Qt6_DIR }}/bin/qmake"
          echo "qmake path: $QMAKE"
          [ -f "$QMAKE" ] || (echo "qmake missing!" && exit 1)

          ./linuxdeploy-x86_64.AppImage --appdir . --plugin qt \
            --executable opt/nst/bin/NST \
            --library opt/nst/lib/libBGACore.so \
            --library opt/nst/lib/libQtLingo.so \
            -v2

          [ -f "usr/plugins/platforms/libqxcb.so" ] || (echo "NO libqxcb.so" && exit 1)

          mkdir -p opt/nst/{lib,plugins,qml}
          rsync -av usr/lib/ opt/nst/lib/ || true
          rsync -av usr/plugins/ opt/nst/plugins/ || true
          rsync -av usr/qml/ opt/nst/qml/ || true

          [ -f "opt/nst/plugins/platforms/libqxcb.so" ] || exit 1
          echo "Qt deployment complete"

          rm -rf usr/lib usr/plugins usr/qml usr/bin

      - name: AppRun
        run: |
          cd AppDir
          cat > AppRun << 'EOF'
          #!/bin/bash
          export APPDIR="${APPDIR:-$(dirname "$(readlink -f "$0")")/..}"
          export LD_LIBRARY_PATH="$APPDIR/opt/nst/lib:$LD_LIBRARY_PATH"
          export QT_PLUGIN_PATH="$APPDIR/opt/nst/plugins"
          export QT_QPA_PLATFORM_PLUGIN_PATH="$APPDIR/opt/nst/plugins/platforms"
          export QT_QPA_PLATFORM=xcb
          exec "$APPDIR/opt/nst/bin/NST" "$@"
          EOF
          chmod +x AppRun
          ln -sf usr/share/applications/nst.desktop .DirIcon
          ln -sf usr/share/icons/hicolor/256x256/apps/nst.png .DirIcon

      - name: Build AppImage
        run: |
          cd AppDir
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage . ../NST-0.4.3-x86_64.AppImage
          cd ..
          chmod +x NST-0.4.3-x86_64.AppImage

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: NST-Linux
          path: NST-0.4.3-x86_64.AppImage
